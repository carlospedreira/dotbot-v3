<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOTBOT // Control Panel</title>
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/modules.css">
    <link rel="stylesheet" href="css/views.css">
    <link rel="stylesheet" href="css/modal.css">
    <link rel="stylesheet" href="css/crt.css">
    <link rel="stylesheet" href="css/processes.css">
    <link rel="stylesheet" href="css/responsive.css">
    <style>
        /* Hide body until theme is loaded to prevent flash */
        body { opacity: 0; transition: opacity 0.15s ease-in; }
        body.theme-loaded { opacity: 1; }
    </style>
</head>
<body>
    <div class="mobile-overlay" id="mobile-overlay"></div>
    <div class="control-panel">
        <!-- Header (v2 style) -->
        <header class="header">
            <button class="hamburger-menu" id="hamburger-menu" aria-label="Toggle menu">
                <!-- Menu icon loaded dynamically -->
            </button>
            <div class="system-id">
                <span class="logo">◈ DOTBOT</span>
                <span class="project-badge" id="project-name">autonomous</span>
            </div>
            <div class="header-signals">
                <div class="signal">
                    <span class="led" id="connection-led"></span>
                    <span id="connection-status">CONNECTING</span>
                </div>
                <div class="signal">
                    <span class="led" id="running-led"></span>
                    <span id="running-status">Idle</span>
                </div>
                <div class="signal">
                    <span class="led off" id="control-led"></span>
                    <span id="control-signal-status">No Signal</span>
                </div>
            </div>
        </header>

        <!-- Tab Bar (Full Width) -->
        <div class="tab-bar-container">
            <div class="tab-bar">
                <div class="tab-group-main">
                    <button class="tab active" data-tab="overview">Overview</button>
                    <button class="tab" data-tab="product">Product</button>
                    <button class="tab" data-tab="pipeline">Roadmap</button>
                    <button class="tab" data-tab="processes">Processes</button>
                    <button class="tab" data-tab="workflow">Workflow</button>
                    <button class="tab" data-tab="settings">Settings</button>
                </div>
                <button class="tab-action" id="whisper-btn">
                    <span class="whisper-icon"></span>
                    <span>WHISPER</span>
                </button>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Left Sidebar (Context-Aware) -->
            <aside class="sidebar-left">
                <!-- Overview Context: Control, Session, Verification (mirrors right sidebar) -->
                <div class="context-panel" data-context="overview">
                    <!-- Agent Control -->
                    <div class="left-module">
                        <div class="module-header">
                            <span class="module-title">◈ Control</span>
                            <span class="led" id="agent-led"></span>
                        </div>
                        <div class="module-content">
                            <div class="agent-status" id="agent-status-block">
                                <div class="agent-state" id="agent-state">
                                    <span class="led off"></span>
                                    <span>Idle</span>
                                </div>
                                <div class="agent-task" id="agent-current-task">No active task</div>
                            </div>
                            <!-- Process Controls -->
                            <div class="control-buttons" id="controls">
                                <div class="process-control-row">
                                    <div class="process-control-header">
                                        <span class="led off" id="analysis-loop-led"></span>
                                        <span class="process-control-label">Analysis</span>
                                    </div>
                                    <div class="process-control-actions">
                                        <button class="ctrl-btn-xs primary" data-action="start-analysis" title="Launch analysis process">Start</button>
                                        <button class="ctrl-btn-xs" data-action="stop-analysis" title="Graceful stop: finish current task then end" disabled>Stop</button>
                                        <button class="ctrl-btn-xs danger" data-action="kill-analysis" title="Immediate: terminate process via PID" disabled>Kill</button>
                                    </div>
                                </div>
                                <div class="process-control-row">
                                    <div class="process-control-header">
                                        <span class="led off" id="execution-loop-led"></span>
                                        <span class="process-control-label">Execution</span>
                                    </div>
                                    <div class="process-control-actions">
                                        <button class="ctrl-btn-xs primary" data-action="start-execution" title="Launch execution process">Start</button>
                                        <button class="ctrl-btn-xs" data-action="stop-execution" title="Graceful stop: finish current task then end" disabled>Stop</button>
                                        <button class="ctrl-btn-xs danger" data-action="kill-execution" title="Immediate: terminate process via PID" disabled>Kill</button>
                                    </div>
                                </div>
                                <div class="process-control-row global">
                                    <div class="process-control-header">
                                        <span class="process-control-label">Global</span>
                                    </div>
                                    <div class="process-control-actions">
                                        <button class="ctrl-btn-xs primary" data-action="start-both" title="Launch both analysis and execution">Both</button>
                                        <button class="ctrl-btn-xs" data-action="stop-all" title="Graceful stop all running processes" disabled>Stop</button>
                                        <button class="ctrl-btn-xs danger" data-action="kill-all" title="Immediately kill all running processes" disabled>Kill</button>
                                    </div>
                                </div>
                            </div>
                            <div class="signal-feedback" id="signal-status"></div>
                        </div>
                    </div>

                    <!-- Session Info with Handoff -->
                    <div class="left-module">
                        <div class="module-header">
                            <span class="module-title">◈ Session</span>
                        </div>
                        <div class="module-content">
                            <div class="session-info">
                                <div class="session-row">
                                    <span class="session-label">ID</span>
                                    <span class="session-value" id="session-id">--</span>
                                </div>
                                <div class="session-row">
                                    <span class="session-label">Status</span>
                                    <span class="session-value" id="session-status-detail">--</span>
                                </div>
                                <div class="session-row">
                                    <span class="session-label">Started</span>
                                    <span class="session-value" id="session-started">--</span>
                                </div>
                                <div class="session-row">
                                    <span class="session-label">Runtime</span>
                                    <span class="session-value" id="session-runtime">--</span>
                                </div>
                                <div class="session-row">
                                    <span class="session-label">Completed</span>
                                    <span class="session-value" id="session-tasks-completed">--</span>
                                </div>
                                <div class="session-row">
                                    <span class="session-label">Skipped</span>
                                    <span class="session-value" id="session-tasks-skipped">--</span>
                                </div>
                                <div class="session-row">
                                    <span class="session-label">Failures</span>
                                    <span class="session-value" id="session-failures">--</span>
                                </div>
                            </div>
                            <!-- Handoff Preview -->
                            <div class="handoff-preview" id="handoff-preview">
                                <div class="handoff-title">◈ Latest Handoff</div>
                                <div class="handoff-text" id="handoff-text">No handoff notes available</div>
                            </div>
                        </div>
                    </div>

                    <!-- Git Status -->
                    <div class="left-module">
                        <div class="module-header">
                            <span class="module-title">◈ Git</span>
                            <span class="led off" id="git-led"></span>
                        </div>
                        <div class="module-content">
                            <div class="git-status-panel" id="git-status-panel">
                                <div class="git-branch-row">
                                    <span class="git-branch-icon">⎇</span>
                                    <span class="git-branch-name" id="git-branch">--</span>
                                    <span class="git-commit-hash" id="git-commit">--</span>
                                </div>
                                <div class="git-upstream-row" id="git-upstream-row" style="display: none;">
                                    <span class="git-upstream-label" id="git-upstream-label">--</span>
                                </div>
                                <div class="git-counts-row" id="git-counts-row">
                                    <span class="git-count-badge staged" id="git-staged-count" title="Staged changes ready to commit" style="display: none;"><span class="badge-label">Staged</span><span class="badge-count">0</span></span>
                                    <span class="git-count-badge unstaged" id="git-unstaged-count" title="Modified files not yet staged" style="display: none;"><span class="badge-label">Modified</span><span class="badge-count">0</span></span>
                                    <span class="git-count-badge untracked" id="git-untracked-count" title="New files not tracked by git" style="display: none;"><span class="badge-label">Untracked</span><span class="badge-count">0</span></span>
                                    <span class="git-clean-badge" id="git-clean-badge">Clean</span>
                                </div>
                                <div class="git-files-list" id="git-files-list" style="display: none;"></div>
                                <div class="git-commit-action" id="git-commit-action" style="display: none;">
                                    <button class="git-commit-btn" id="git-commit-btn" title="Invoke Claude to commit and push changes">
                                        <span class="git-commit-btn-icon">◈</span>
                                        <span class="git-commit-btn-text">Commit &amp; Push</span>
                                        <span class="git-commit-btn-loading" style="display: none;">Working...</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Panic Button - Reset stale state -->
                    <div class="panic-section">
                        <button class="panic-btn" id="panic-reset" data-action="reset" title="Clear stale state files and locks">
                            <span class="panic-icon"><!-- Icon injected by JS --></span>
                            <span class="panic-label">RESET</span>
                        </button>
                        <div class="panic-hint">Clear stale locks &amp; signals</div>
                    </div>
                </div>

                <!-- Product Context: File Navigator -->
                <div class="context-panel hidden" data-context="product">
                    <div class="sidebar-section">
                        <div class="sidebar-header">
                            <span class="sidebar-title">◈ Product Docs</span>
                        </div>
                        <div class="sidebar-content" id="product-file-nav">
                            <div class="loading-state">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Pipeline/Roadmap Context: Task Summary -->
                <div class="context-panel hidden" data-context="pipeline">
                    <div class="sidebar-section">
                        <div class="sidebar-header">
                            <span class="sidebar-title">◈ Task Summary</span>
                        </div>
                        <div class="sidebar-content">
                            <div class="task-summary">
                                <div class="summary-item todo">
                                    <span class="summary-label">Todo</span>
                                    <span class="count-badge" data-status="todo" id="context-todo-count">-</span>
                                </div>
                                <div class="summary-item analysing">
                                    <span class="summary-label">Analysing</span>
                                    <span class="count-badge" id="context-analysing-count">-</span>
                                </div>
                                <div class="summary-item needs-input">
                                    <span class="summary-label">Needs Input</span>
                                    <span class="count-badge" id="context-needs-input-count">-</span>
                                </div>
                                <div class="summary-item analysed">
                                    <span class="summary-label">Analysed</span>
                                    <span class="count-badge" id="context-analysed-count">-</span>
                                </div>
                                <div class="summary-item in-progress">
                                    <span class="summary-label">In Progress</span>
                                    <span class="count-badge" data-status="in-progress" id="context-progress-count">-</span>
                                </div>
                                <div class="summary-item done">
                                    <span class="summary-label">Done</span>
                                    <span class="count-badge" data-status="done" id="context-done-count">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <div class="sidebar-header">
                            <span class="sidebar-title">◈ Progress</span>
                        </div>
                        <div class="sidebar-content">
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="context-progress-bar"></div>
                            </div>
                            <div class="progress-label" id="context-progress-label">0%</div>
                        </div>
                    </div>

                    <div class="sidebar-section">
                        <div class="sidebar-header">
                            <span class="sidebar-title">◈ Other</span>
                        </div>
                        <div class="sidebar-content">
                            <div class="task-summary secondary">
                                <div class="summary-item skipped">
                                    <span class="summary-label">Skipped</span>
                                    <span class="count-badge muted" id="context-skipped-count">-</span>
                                </div>
                                <div class="summary-item cancelled">
                                    <span class="summary-label">Cancelled</span>
                                    <span class="count-badge muted" id="context-cancelled-count">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Processes Context: Process Summary -->
                <div class="context-panel hidden" data-context="processes">
                    <div class="sidebar-section">
                        <div class="sidebar-header">
                            <span class="sidebar-title">◈ Processes</span>
                        </div>
                        <div class="sidebar-content">
                            <div class="process-summary">
                                <div class="summary-item">
                                    <span class="summary-label">Running</span>
                                    <span class="summary-value active" id="proc-running-count">0</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Completed</span>
                                    <span class="summary-value" id="proc-completed-count">0</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Failed</span>
                                    <span class="summary-value" id="proc-failed-count">0</span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">Total Tasks</span>
                                    <span class="summary-value" id="proc-total-tasks">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="sidebar-section">
                        <div class="sidebar-header">
                            <span class="sidebar-title">◈ Quick Launch</span>
                        </div>
                        <div class="sidebar-content">
                            <div style="display: flex; flex-direction: column; gap: 6px;">
                                <button class="ctrl-btn primary" id="quick-launch-analysis" style="width: 100%; font-size: 10px;">Launch Analysis</button>
                                <button class="ctrl-btn primary" id="quick-launch-execution" style="width: 100%; font-size: 10px;">Launch Execution</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Workflow Context: Dynamic Prompts Directories -->
                <div class="context-panel hidden" data-context="workflow">
                    <div id="prompts-sidebar">
                        <!-- Dynamically populated based on /api/prompts/directories -->
                        <div class="loading-state">Loading prompt directories...</div>
                    </div>
                </div>

                <!-- Settings Context -->
                <div class="context-panel hidden" data-context="settings">
                    <div class="sidebar-section">
                        <div class="sidebar-header">
                            <span class="sidebar-title">◈ Settings</span>
                        </div>
                        <div class="sidebar-content">
                            <div class="settings-nav">
                                <div class="settings-nav-item active" data-settings-section="theme">Theme</div>
                                <div class="settings-nav-item" data-settings-section="analysis">Analysis</div>
                                <div class="settings-nav-item" data-settings-section="execution">Execution</div>
                                <div class="settings-nav-item" data-settings-section="verification">Verification</div>
                                <div class="settings-nav-item" data-settings-section="aether" id="aetherNavItem" style="display:none">Aether</div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Overview Tab -->
                    <div class="tab-pane active" id="tab-overview">
                        <!-- Executive Summary -->
                        <div class="executive-summary" id="executive-summary" style="display: none;"></div>

                        <!-- Stats Row -->
                        <div class="stats-row">
                            <div class="stat-card">
                                <div class="stat-label">TODO</div>
                                <div class="stat-value" data-status="todo" id="todo-count">-</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">ANALYSING</div>
                                <div class="stat-value" data-status="in-progress" id="analysing-count">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">AWAITING INPUT</div>
                                <div class="stat-value" data-status="todo" id="needs-input-count">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">READY</div>
                                <div class="stat-value" data-status="todo" id="analysed-count">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">IN PROGRESS</div>
                                <div class="stat-value" data-status="in-progress" id="progress-count">-</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">DONE</div>
                                <div class="stat-value" data-status="done" id="done-count">-</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">PROGRESS</div>
                                <div class="stat-value" id="progress-percent">-</div>
                            </div>
                        </div>

                        <!-- Activity Oscilloscope -->
                        <div id="activity-scope" class="crt-monitor">
                            <div class="crt-bezel">
                                <div class="crt-screen">
                                    <!-- Oscilloscope waveform (background) -->
                                    <canvas id="scope-canvas" width="800" height="120"></canvas>
                                    <!-- Message overlay on top of scope -->
                                    <div class="crt-overlay">
                                        <!-- Tool pill (top right) -->
                                        <div class="tool-pill" id="tool-pill">IDLE</div>
                                        <!-- Green text area (Claude's output) -->
                                        <div class="text-output" id="text-output">Waiting for activity...</div>
                                        <!-- Amber command area -->
                                        <div class="command-text" id="command-text"></div>
                                    </div>
                                    <div class="crt-scanlines"></div>
                                    <div class="crt-flicker"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Active Processes Widget -->
                        <div class="module" id="active-processes-module">
                            <div class="module-header">
                                <span class="module-title">◈ Active Processes</span>
                                <span class="module-badge" id="active-process-count">0</span>
                            </div>
                            <div class="module-screen">
                                <div id="active-processes-list">
                                    <div class="empty-state">No running processes</div>
                                </div>
                                <div class="view-all-link" id="view-all-processes" style="display: none;">
                                    <a href="#" onclick="switchToTab('processes'); return false;">View All Processes &rarr;</a>
                                </div>
                            </div>
                        </div>

                        <!-- Current Task Module -->
                        <div class="module">
                            <div class="module-header">
                                <span class="module-title">◈ Current Task</span>
                                <span class="module-badge" id="current-task-status">--</span>
                            </div>
                            <div class="module-screen">
                                <div class="current-task" id="current-task">
                                    <div class="empty-state">No task in progress</div>
                                </div>
                            </div>
                        </div>

                        <!-- Two Column: Upcoming + Completed -->
                        <div class="two-column">
                            <div class="module">
                                <div class="module-header">
                                    <span class="module-title">◈ Upcoming</span>
                                    <button class="ctrl-btn-sm primary add-task-btn" id="add-task-btn-upcoming" title="Add new task">New Task</button>
                                </div>
                                <div class="module-screen">
                                    <div class="task-list" id="upcoming-tasks">
                                        <div class="loading-state">Loading...</div>
                                    </div>
                                </div>
                            </div>

                            <div class="module">
                                <div class="module-header">
                                    <span class="module-title">◈ Recently Completed</span>
                                </div>
                                <div class="module-screen">
                                    <div class="task-list" id="completed-tasks">
                                        <div class="loading-state">Loading...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pipeline Tab -->
                    <div class="tab-pane" id="tab-pipeline">
                        <div class="pipeline-wrapper">
                            <!-- Analysis Pipeline Stage -->
                            <div class="pipeline-stage">
                                <div class="pipeline-stage-header">
                                    <span class="pipeline-stage-title analysis">◈ Analysis Pipeline</span>
                                </div>
                                <div class="pipeline-container">
                                    <!-- Todo Column -->
                                    <div class="pipeline-column">
                                        <div class="column-header">
                                            <span class="column-label">◇ Todo</span>
                                            <span class="column-count" id="pipeline-todo-count">0</span>
                                            <button class="ctrl-btn-sm primary add-task-btn" id="add-task-btn-pipeline" title="Add new task">New Task</button>
                                        </div>
                                        <div class="column-items" id="pipeline-todo">
                                            <div class="loading-state">Loading...</div>
                                        </div>
                                    </div>

                                    <div class="flow-arrow">→</div>

                                    <!-- Analysing Column -->
                                    <div class="pipeline-column">
                                        <div class="column-header">
                                            <span class="column-label">◈ Analysing</span>
                                            <span class="column-count" id="pipeline-analysing-count">0</span>
                                        </div>
                                        <div class="column-items" id="pipeline-analysing">
                                            <div class="empty-state">No tasks</div>
                                        </div>
                                    </div>

                                    <div class="flow-arrow">→</div>

                                    <!-- Needs Input Column -->
                                    <div class="pipeline-column highlight">
                                        <div class="column-header">
                                            <span class="column-label">⚡ Needs Input</span>
                                            <span class="column-count" id="pipeline-needs-input-count">0</span>
                                        </div>
                                        <div class="column-items" id="pipeline-needs-input">
                                            <div class="empty-state">No tasks</div>
                                        </div>
                                    </div>

                                    <div class="flow-arrow">→</div>

                                    <!-- Analysed Column -->
                                    <div class="pipeline-column">
                                        <div class="column-header">
                                            <span class="column-label">✓ Analysed</span>
                                            <span class="column-count" id="pipeline-analysed-count">0</span>
                                        </div>
                                        <div class="column-items" id="pipeline-analysed">
                                            <div class="empty-state">No tasks</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Execution Pipeline Stage -->
                            <div class="pipeline-stage">
                                <div class="pipeline-stage-header">
                                    <span class="pipeline-stage-title execution">◈ Execution Pipeline</span>
                                </div>
                                <div class="pipeline-container">
                                    <!-- Analysed Column (shared input) -->
                                    <div class="pipeline-column">
                                        <div class="column-header">
                                            <span class="column-label">◇ Ready</span>
                                            <span class="column-count" id="pipeline-ready-count">0</span>
                                        </div>
                                        <div class="column-items" id="pipeline-ready">
                                            <div class="empty-state">No tasks</div>
                                        </div>
                                    </div>

                                    <div class="flow-arrow">→</div>

                                    <!-- In Progress Column -->
                                    <div class="pipeline-column highlight">
                                        <div class="column-header">
                                            <span class="column-label">◈ In Progress</span>
                                            <span class="column-count" id="pipeline-progress-count">0</span>
                                        </div>
                                        <div class="column-items" id="pipeline-progress">
                                            <div class="empty-state">No active tasks</div>
                                        </div>
                                    </div>

                                    <div class="flow-arrow">→</div>

                                    <!-- Done Column -->
                                    <div class="pipeline-column">
                                        <div class="column-header">
                                            <span class="column-label">✓ Done</span>
                                            <span class="column-count" id="pipeline-done-count">0</span>
                                        </div>
                                        <div class="column-items" id="pipeline-done">
                                            <div class="loading-state">Loading...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Processes Tab -->
                    <div class="tab-pane" id="tab-processes">
                        <!-- Launch Bar -->
                        <div class="process-launch-bar">
                            <div class="process-launch-group">
                                <label>Type</label>
                                <select id="process-type-select">
                                    <option value="analysis">Analysis</option>
                                    <option value="execution">Execution</option>
                                    <option value="kickstart">Kickstart</option>
                                    <option value="planning">Planning</option>
                                    <option value="commit">Commit</option>
                                    <option value="task-creation">Task Creation</option>
                                </select>
                            </div>
                            <div class="process-launch-group" id="process-continue-group">
                                <label>
                                    <input type="checkbox" id="process-continue-check"> Continue
                                </label>
                            </div>
                            <div class="process-launch-group">
                                <label>Model</label>
                                <select id="process-model-select">
                                    <option value="">Default</option>
                                    <option value="Opus">Opus</option>
                                    <option value="Sonnet">Sonnet</option>
                                    <option value="Haiku">Haiku</option>
                                </select>
                            </div>
                            <div class="process-launch-group" id="process-prompt-group" style="display: none; flex: 1;">
                                <label>Prompt</label>
                                <input type="text" id="process-prompt-input" class="process-prompt-input" placeholder="Optional prompt context...">
                            </div>
                            <button class="ctrl-btn primary" id="process-launch-btn">LAUNCH</button>
                        </div>

                        <!-- Process List -->
                        <div id="process-list">
                            <div class="empty-state">No processes</div>
                        </div>
                    </div>

                    <!-- Workflow Tab -->
                    <div class="tab-pane" id="tab-workflow">
                        <div class="workflow-viewer">
                            <!-- Left: Markdown Content Panel -->
                            <div class="markdown-panel">
                                <div class="markdown-header">
                                    <span class="markdown-title" id="workflow-doc-title">Select an item</span>
                                </div>
                                <div class="markdown-content" id="workflow-doc-content">
                                    <div class="doc-placeholder">Select a command, workflow, agent, or standard from the sidebar</div>
                                </div>
                            </div>

                            <!-- Right: Relationship Panel -->
                            <div class="relationship-panel">
                                <div class="relationship-header">◈ Relationships</div>
                                <div class="relationship-tree" id="relationship-tree">
                                    <!-- Populated dynamically -->
                                    <div class="empty-state">Select an item from the sidebar</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Product Tab -->
                    <div class="tab-pane" id="tab-product">
                        <div class="product-viewer">
                            <div class="product-content full-width">
                                <div class="doc-viewer" id="doc-viewer">
                                    <div class="doc-placeholder">Select a document from the left panel</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Tab -->
                    <div class="tab-pane" id="tab-settings">
                        <div class="settings-container">
                            <!-- Theme Section -->
                            <div class="settings-section" id="settings-theme">
                                <div class="module">
                                    <div class="module-header">
                                        <span class="module-title">◈ Theme</span>
                                    </div>
                                    <div class="module-screen">
                                        <div class="settings-description">
                                            Choose a color theme for the control panel. Changes are saved automatically.
                                        </div>
                                        <div class="theme-grid" id="theme-grid">
                                            <!-- Theme options populated by JS -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Analysis Section -->
                            <div class="settings-section hidden" id="settings-analysis">
                                <div class="module">
                                    <div class="module-header">
                                        <span class="module-title">◈ Analysis</span>
                                    </div>
                                    <div class="module-screen">
                                        <div class="settings-description">
                                            Configure how the analysis loop processes tasks.
                                        </div>
                                        <div class="settings-group">
                                            <div class="setting-row">
                                                <div class="setting-info">
                                                    <span class="setting-label">Auto-Approve Splits</span>
                                                    <span class="setting-description">Automatically approve task split proposals without human review</span>
                                                </div>
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="setting-auto-approve-splits">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                            </div>
                                        </div>

                                        <div class="settings-subsection">
                                            <div class="subsection-header">Split Threshold Effort</div>
                                            <div class="settings-description">
                                                Tasks at or above this effort level may be split into smaller sub-tasks.
                                            </div>
                                            <div class="model-grid" id="effort-threshold-grid">
                                                <!-- Effort options populated by JS -->
                                            </div>
                                        </div>

                                        <div class="settings-subsection">
                                            <div class="subsection-header">Analysis Mode</div>
                                            <div class="settings-description">
                                                How the analysis loop picks up tasks for pre-flight analysis.
                                            </div>
                                            <div class="model-grid" id="analysis-mode-grid">
                                                <!-- Mode options populated by JS -->
                                            </div>
                                        </div>

                                        <div class="settings-subsection">
                                            <div class="subsection-header">Question Timeout</div>
                                            <div class="settings-description">
                                                Hours to wait for human answers before auto-skipping. Leave empty for no timeout.
                                            </div>
                                            <div class="setting-row">
                                                <div class="setting-info">
                                                    <span class="setting-label">Timeout (hours)</span>
                                                    <span class="setting-description">Auto-skip tasks after this many hours without a response</span>
                                                </div>
                                                <input type="number" class="settings-number-input" id="setting-question-timeout" min="0" step="1" placeholder="No timeout">
                                            </div>
                                        </div>

                                        <div class="settings-subsection">
                                            <div class="subsection-header">Model</div>
                                            <div class="settings-description">
                                                Select the Claude model to use for task analysis.
                                            </div>
                                            <div class="model-grid" id="analysis-model-grid">
                                                <!-- Model options populated by JS -->
                                            </div>
                                        </div>

                                        <div class="settings-note">
                                            Changes take effect on next analysis loop iteration.
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Execution Section -->
                            <div class="settings-section hidden" id="settings-execution">
                                <div class="module">
                                    <div class="module-header">
                                        <span class="module-title">◈ Execution</span>
                                    </div>
                                    <div class="module-screen">
                                        <div class="settings-description">
                                            Configure the execution loop model and debug output.
                                        </div>
                                        <div class="settings-subsection">
                                            <div class="subsection-header">Model</div>
                                            <div class="settings-description">
                                                Select the Claude model to use for task execution.
                                            </div>
                                            <div class="model-grid" id="execution-model-grid">
                                                <!-- Model options populated by JS -->
                                            </div>
                                        </div>

                                        <div class="settings-subsection">
                                            <div class="subsection-header">Debug Output</div>
                                            <div class="settings-description">
                                                Configure debug and verbose output for the autonomous loop.
                                            </div>
                                            <div class="settings-group">
                                                <div class="setting-row">
                                                    <div class="setting-info">
                                                        <span class="setting-label">Show Debug Output</span>
                                                        <span class="setting-description">Display raw JSON events and Claude invocation details</span>
                                                    </div>
                                                    <label class="toggle-switch">
                                                        <input type="checkbox" id="setting-show-debug">
                                                        <span class="toggle-slider"></span>
                                                    </label>
                                                </div>
                                                <div class="setting-row">
                                                    <div class="setting-info">
                                                        <span class="setting-label">Show Verbose Output</span>
                                                        <span class="setting-description">Display detailed tool results and metadata</span>
                                                    </div>
                                                    <label class="toggle-switch">
                                                        <input type="checkbox" id="setting-show-verbose">
                                                        <span class="toggle-slider"></span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="settings-note">
                                            Changes take effect on next execution loop start.
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Verification Section -->
                            <div class="settings-section hidden" id="settings-verification">
                                <div class="module">
                                    <div class="module-header">
                                        <span class="module-title">◈ Verification</span>
                                    </div>
                                    <div class="module-screen">
                                        <div class="settings-description">
                                            Configure which verification scripts run after task completion. Core scripts cannot be disabled.
                                        </div>
                                        <div id="verification-scripts-list">
                                            <!-- Verification script rows populated by JS -->
                                            <div class="loading-state">Loading scripts...</div>
                                        </div>
                                        <div class="settings-note" style="margin-top: 16px;">
                                            Changes take effect immediately on next task completion.
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Aether Section -->
                            <div class="settings-section hidden" id="settings-aether">
                                <div class="module">
                                    <div class="module-header">
                                        <span class="module-title">◈ Aether</span>
                                    </div>
                                    <div class="module-screen">
                                        <!-- Bond Panel (pre-link) -->
                                        <div class="aether-screen" id="aetherBondPanel">
                                            <div class="aether-mystery">
                                                <div class="aether-glyph">◈</div>
                                                <div class="aether-prompt">Something resonates nearby...</div>
                                                <div class="aether-bond-status idle" id="aetherBondStatus">
                                                    <span id="aetherBondMessage">Press to begin bonding</span>
                                                    <span class="aether-countdown" id="aetherCountdown" style="display:none">30</span>
                                                </div>
                                                <button class="ctrl-btn primary" id="aetherBondBtn">BOND</button>
                                            </div>
                                        </div>

                                        <!-- Config Panel (post-link) -->
                                        <div class="aether-screen" id="aetherConfigPanel" style="display:none">
                                            <!-- Activity indicator -->
                                            <div class="aether-activity">
                                                <div class="aether-activity-dot"></div>
                                                <span class="aether-activity-label">Monitoring</span>
                                            </div>

                                            <!-- Stats -->
                                            <div class="aether-stats">
                                                <div class="aether-stat">
                                                    <div class="aether-stat-value" data-type="success" id="aetherStartCount">0</div>
                                                    <div class="aether-stat-label">Starts</div>
                                                </div>
                                                <div class="aether-stat">
                                                    <div class="aether-stat-value" data-type="info" id="aetherCompleteCount">0</div>
                                                    <div class="aether-stat-label">Complete</div>
                                                </div>
                                                <div class="aether-stat">
                                                    <div class="aether-stat-value" data-type="warning" id="aetherErrorCount">0</div>
                                                    <div class="aether-stat-label">Errors</div>
                                                </div>
                                            </div>

                                            <!-- Last event -->
                                            <div class="aether-last-event" id="aetherLastEvent">
                                                <span class="event-type">--</span>
                                                <span class="event-time">waiting for events</span>
                                            </div>

                                            <div class="settings-group">
                                                <div class="setting-row">
                                                    <div class="setting-info">
                                                        <span class="setting-label">Conduit</span>
                                                        <span class="setting-description" id="aetherConduitInfo">--</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="aether-node-section">
                                                <div class="subsection-header">Nodes</div>
                                                <div class="aether-node-list" id="aetherNodeList">
                                                    <div class="aether-empty">Loading nodes...</div>
                                                </div>
                                            </div>
                                            <div class="aether-actions">
                                                <button class="ctrl-btn" id="aetherTestBtn">TEST PULSE</button>
                                                <button class="ctrl-btn danger" id="aetherUnlinkBtn">UNLINK</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Footer (v3 style) -->
        <footer class="footer">
            <div class="footer-left">
                <span class="footer-label">LAST UPDATE:</span>
                <span class="footer-value" id="last-update">--:--:--</span>
                <span class="footer-sep">|</span>
                <span class="footer-label">REFRESH:</span>
                <span class="footer-value" data-type="primary">5s</span>
                <span class="footer-sep">|</span>
                <span class="footer-label">CACHE:</span>
                <span class="footer-value" id="cache-status">--</span>
            </div>
            <div class="footer-center">
                <span class="footer-mission" id="footer-mission">◈ .bot autonomous development system</span>
            </div>
            <div class="footer-right">
                <span class="footer-label">v0.4.0</span>
            </div>
        </footer>
    </div>

    <!-- Task Detail Modal -->
    <div class="modal-overlay" id="task-modal">
        <div class="modal modal-task-detail">
            <div class="modal-header">
                <span class="modal-title" id="modal-task-name">Task Details</span>
                <button class="modal-close" id="modal-close"><!-- Close icon loaded dynamically --></button>
            </div>
            <div class="modal-body" id="modal-task-content">
                <!-- Task details rendered by showTaskModal() -->
            </div>
        </div>
    </div>

    <!-- Action Required Floating Widget -->
    <div class="action-widget hidden" id="action-widget">
        <span class="action-widget-icon">⚡</span>
        <span class="action-widget-label">Action Required</span>
        <span class="action-widget-count" id="action-widget-count">0</span>
    </div>

    <!-- Slide-out Panel for Actions -->
    <div class="slideout-overlay" id="slideout-overlay"></div>
    <div class="slideout-panel" id="slideout-panel">
        <div class="slideout-header">
            <span class="slideout-title">◈ Action Required</span>
            <button class="slideout-close" id="slideout-close">×</button>
        </div>
        <div class="slideout-content" id="slideout-content">
            <div class="empty-state">No pending actions</div>
        </div>
    </div>

    <!-- Plan Viewer Modal -->
    <div class="modal-overlay" id="plan-modal">
        <div class="modal modal-wide">
            <div class="modal-header">
                <span class="modal-title" id="plan-modal-title">Implementation Plan</span>
                <button class="modal-close" id="plan-modal-close"><!-- Close icon loaded dynamically --></button>
            </div>
            <div class="modal-body markdown-content" id="plan-modal-content">
                <!-- Plan markdown rendered here -->
            </div>
            <div class="modal-footer">
                <button class="ctrl-btn" id="plan-modal-back">Back to Task</button>
            </div>
        </div>
    </div>

    <!-- Whisper Modal -->
    <div class="modal-overlay" id="whisper-modal">
        <div class="modal whisper-modal">
            <div class="modal-header">
                <span class="modal-icon"></span>
                <span class="modal-title">Whisper to DotBot</span>
                <button class="modal-close" id="whisper-modal-close"><!-- Close icon loaded dynamically --></button>
            </div>
            <div class="modal-body whisper-modal-body">
                <!-- Instance Selector Label -->
                <div class="whisper-section-label">Select an instance</div>

                <!-- Instance Selector -->
                <div class="instance-selector">
                    <button class="instance-btn" data-instance="analysis" id="btn-analysis" disabled>
                        <span class="instance-led dead" id="led-analysis"></span>
                        <span>Analysis</span>
                        <span class="instance-pid" id="pid-analysis"></span>
                    </button>
                    <button class="instance-btn" data-instance="execution" id="btn-execution" disabled>
                        <span class="instance-led dead" id="led-execution"></span>
                        <span>Execution</span>
                        <span class="instance-pid" id="pid-execution"></span>
                    </button>
                </div>

                <!-- Status Display -->
                <div class="steering-status" id="steering-status">
                    <div class="steering-text muted" id="steering-text">No instance selected</div>
                </div>

                <!-- Whisper Input -->
                <div class="whisper-form">
                    <textarea id="whisper-input" class="whisper-input"
                              placeholder="Send guidance..." maxlength="500" rows="3" disabled></textarea>
                    <div class="whisper-actions">
                        <select id="whisper-priority" class="whisper-priority" disabled>
                            <option value="normal">Normal</option>
                            <option value="urgent">Urgent</option>
                            <option value="abort">Abort</option>
                        </select>
                        <button class="ctrl-btn primary" id="whisper-send" disabled>SEND</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Creation Modal -->
    <div class="modal-overlay" id="task-create-modal">
        <div class="modal modal-wide">
            <div class="modal-header">
                <span class="modal-title">◈ Create New Task</span>
                <button class="modal-close" id="task-create-modal-close"><!-- Close icon loaded dynamically --></button>
            </div>
            <div class="modal-body">
                <div class="task-create-form">
                    <div class="form-group">
                        <label class="form-label">Describe what you want to accomplish</label>
                        <textarea class="form-textarea" id="task-create-prompt" placeholder="Example: Add a dark mode toggle to the settings page with persistent user preference..." rows="6"></textarea>
                    </div>
                    <div class="form-hint">
                        Dotbot will analyze your request and create a properly structured task with acceptance criteria, implementation steps, and sensible defaults.
                    </div>
                    <div class="form-option">
                        <label class="form-checkbox-label">
                            <input type="checkbox" id="task-create-interview">
                            <span class="form-checkbox-text">Interview me to clarify requirements</span>
                        </label>
                        <div class="form-option-hint">Dotbot will ask clarifying questions before finalizing the task</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer task-create-footer">
                <button class="ctrl-btn" id="task-create-cancel">Cancel</button>
                <button class="ctrl-btn primary" id="task-create-submit">
                    <span class="btn-text">Create Task</span>
                    <span class="btn-loading" style="display: none;">Creating...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Kickstart Project Modal -->
    <div class="modal-overlay" id="kickstart-modal">
        <div class="modal modal-wide">
            <div class="modal-header">
                <span class="modal-title">◈ Kickstart Project</span>
                <button class="modal-close" id="kickstart-modal-close"><!-- Close icon loaded dynamically --></button>
            </div>
            <div class="modal-body">
                <div class="task-create-form">
                    <div class="form-group">
                        <label class="form-label">Describe your project</label>
                        <textarea class="form-textarea" id="kickstart-prompt" placeholder="What are you building? What problem does it solve? What technologies are you using?" rows="6"></textarea>
                    </div>
                    <div class="form-hint">
                        Claude will create your mission, tech stack, and entity model documents based on your description and any attached files.
                    </div>
                    <div class="form-group">
                        <label class="form-label">Attach context files (optional)</label>
                        <div class="kickstart-dropzone" id="kickstart-dropzone">
                            <div class="dropzone-content">
                                <div class="dropzone-icon">◇</div>
                                <div class="dropzone-text">Drop files here or click to browse</div>
                                <div class="dropzone-hint">Code, docs, images, data & config files — max 2MB each</div>
                            </div>
                        </div>
                        <input type="file" id="kickstart-file-input" style="display: none;" multiple accept=".md,.txt,.pdf,.rtf,.json,.yaml,.yml,.toml,.xml,.csv,.tsv,.ini,.env,.properties,.cfg,.conf,.html,.css,.scss,.less,.svg,.js,.ts,.tsx,.jsx,.py,.cs,.java,.go,.rs,.rb,.php,.swift,.kt,.c,.cpp,.h,.hpp,.sh,.ps1,.sql,.r,.lua,.dart,.vue,.svelte,.png,.jpg,.jpeg,.gif,.webp,.ipynb">
                        <div id="kickstart-file-list" class="kickstart-file-list"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer task-create-footer">
                <button class="ctrl-btn" id="kickstart-cancel">Cancel</button>
                <button class="ctrl-btn primary" id="kickstart-submit">
                    <span class="btn-text">Kickstart</span>
                    <span class="btn-loading" style="display: none;">Starting...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Toast notifications -->
    <div class="toast-container" id="toast-container"></div>

    <!-- External dependencies -->
    <script src="scope.js"></script>

    <!-- Modules (dependency order) -->
    <script src="modules/config.js"></script>
    <script src="modules/utils.js"></script>
    <script src="modules/icons.js"></script>
    <script src="modules/theme.js"></script>
    <script src="modules/markdown.js"></script>
    <script src="modules/mermaid-loader.js"></script>
    <script src="modules/tabs.js"></script>
    <script src="modules/sidebar.js"></script>
    <script src="modules/workflow.js"></script>
    <script src="modules/product.js"></script>
    <script src="modules/kickstart.js"></script>
    <script src="modules/tasks.js"></script>
    <script src="modules/processes.js"></script>
    <script src="modules/controls.js"></script>
    <script src="modules/activity.js"></script>
    <script src="modules/polling.js"></script>
    <script src="modules/ui-updates.js"></script>
    <script src="modules/actions.js"></script>
    <script src="modules/notifications.js"></script>
    <script src="modules/aether.js"></script>

    <!-- Main entry point (must be last) -->
    <script src="app.js"></script>
</body>
</html>
